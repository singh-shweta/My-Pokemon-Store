{"ast":null,"code":"import { __assign, __spreadArray } from \"tslib\";\nimport * as React from \"rehackt\";\nimport { useApolloClient } from \"./useApolloClient.js\";\nimport { assertWrappedQueryRef, getSuspenseCache, unwrapQueryRef, updateWrappedQueryRef, wrapQueryRef } from \"../internal/index.js\";\nimport { useRenderGuard } from \"./internal/index.js\";\nimport { useWatchQueryOptions } from \"./useSuspenseQuery.js\";\nimport { canonicalStringify } from \"../../cache/index.js\";\nimport { invariant } from \"../../utilities/globals/index.js\";\nexport function useLoadableQuery(query, options) {\n  if (options === void 0) {\n    options = Object.create(null);\n  }\n  var client = useApolloClient(options.client);\n  var suspenseCache = getSuspenseCache(client);\n  var watchQueryOptions = useWatchQueryOptions({\n    client: client,\n    query: query,\n    options: options\n  });\n  var _a = options.queryKey,\n    queryKey = _a === void 0 ? [] : _a;\n  var _b = React.useState(null),\n    queryRef = _b[0],\n    setQueryRef = _b[1];\n  assertWrappedQueryRef(queryRef);\n  var internalQueryRef = queryRef && unwrapQueryRef(queryRef);\n  if (queryRef && (internalQueryRef === null || internalQueryRef === void 0 ? void 0 : internalQueryRef.didChangeOptions(watchQueryOptions))) {\n    var promise = internalQueryRef.applyOptions(watchQueryOptions);\n    updateWrappedQueryRef(queryRef, promise);\n  }\n  var calledDuringRender = useRenderGuard();\n  var fetchMore = React.useCallback(function (options) {\n    if (!internalQueryRef) {\n      throw new Error(\"The query has not been loaded. Please load the query.\");\n    }\n    var promise = internalQueryRef.fetchMore(options);\n    setQueryRef(wrapQueryRef(internalQueryRef));\n    return promise;\n  }, [internalQueryRef]);\n  var refetch = React.useCallback(function (options) {\n    if (!internalQueryRef) {\n      throw new Error(\"The query has not been loaded. Please load the query.\");\n    }\n    var promise = internalQueryRef.refetch(options);\n    setQueryRef(wrapQueryRef(internalQueryRef));\n    return promise;\n  }, [internalQueryRef]);\n  var loadQuery = React.useCallback(function () {\n    var args = [];\n    for (var _i = 0; _i < arguments.length; _i++) {\n      args[_i] = arguments[_i];\n    }\n    invariant(!calledDuringRender(), 51);\n    var variables = args[0];\n    var cacheKey = __spreadArray([query, canonicalStringify(variables)], [].concat(queryKey), true);\n    var queryRef = suspenseCache.getQueryRef(cacheKey, function () {\n      return client.watchQuery(__assign(__assign({}, watchQueryOptions), {\n        variables: variables\n      }));\n    });\n    setQueryRef(wrapQueryRef(queryRef));\n  }, [query, queryKey, suspenseCache, watchQueryOptions, calledDuringRender, client]);\n  var subscribeToMore = React.useCallback(function (options) {\n    invariant(internalQueryRef, 52);\n    return internalQueryRef.observable.subscribeToMore(options);\n  }, [internalQueryRef]);\n  var reset = React.useCallback(function () {\n    setQueryRef(null);\n  }, []);\n  return [loadQuery, queryRef, {\n    fetchMore: fetchMore,\n    refetch: refetch,\n    reset: reset,\n    subscribeToMore: subscribeToMore\n  }];\n}","map":{"version":3,"sources":["../../../src/react/hooks/useLoadableQuery.ts"],"names":[],"mappings":"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","sourcesContent":["import * as React from \"rehackt\";\nimport type {\n  DocumentNode,\n  FetchMoreQueryOptions,\n  OperationVariables,\n  TypedDocumentNode,\n  WatchQueryOptions,\n} from \"../../core/index.js\";\nimport { useApolloClient } from \"./useApolloClient.js\";\nimport {\n  assertWrappedQueryRef,\n  getSuspenseCache,\n  unwrapQueryRef,\n  updateWrappedQueryRef,\n  wrapQueryRef,\n} from \"../internal/index.js\";\nimport type { CacheKey, QueryRef } from \"../internal/index.js\";\nimport type { LoadableQueryHookOptions } from \"../types/types.js\";\nimport { __use, useRenderGuard } from \"./internal/index.js\";\nimport { useWatchQueryOptions } from \"./useSuspenseQuery.js\";\nimport type {\n  FetchMoreFunction,\n  RefetchFunction,\n  SubscribeToMoreFunction,\n} from \"./useSuspenseQuery.js\";\nimport { canonicalStringify } from \"../../cache/index.js\";\nimport type {\n  DeepPartial,\n  OnlyRequiredProperties,\n} from \"../../utilities/index.js\";\nimport { invariant } from \"../../utilities/globals/index.js\";\n\nexport type LoadQueryFunction<TVariables extends OperationVariables> = (\n  // Use variadic args to handle cases where TVariables is type `never`, in\n  // which case we don't want to allow a variables argument. In other\n  // words, we don't want to allow variables to be passed as an argument to this\n  // function if the query does not expect variables in the document.\n  ...args: [TVariables] extends [never] ? []\n  : {} extends OnlyRequiredProperties<TVariables> ? [variables?: TVariables]\n  : [variables: TVariables]\n) => void;\n\ntype ResetFunction = () => void;\n\nexport type UseLoadableQueryResult<\n  TData = unknown,\n  TVariables extends OperationVariables = OperationVariables,\n> = [\n  loadQuery: LoadQueryFunction<TVariables>,\n  queryRef: QueryRef<TData, TVariables> | null,\n  handlers: {\n    /** {@inheritDoc @apollo/client!QueryResultDocumentation#fetchMore:member} */\n    fetchMore: FetchMoreFunction<TData, TVariables>;\n    /** {@inheritDoc @apollo/client!QueryResultDocumentation#refetch:member} */\n    refetch: RefetchFunction<TData, TVariables>;\n    /** {@inheritDoc @apollo/client!ObservableQuery#subscribeToMore:member(1)} */\n    subscribeToMore: SubscribeToMoreFunction<TData, TVariables>;\n    /**\n     * A function that resets the `queryRef` back to `null`.\n     */\n    reset: ResetFunction;\n  },\n];\n\nexport function useLoadableQuery<\n  TData,\n  TVariables extends OperationVariables,\n  TOptions extends LoadableQueryHookOptions,\n>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: LoadableQueryHookOptions & TOptions\n): UseLoadableQueryResult<\n  TOptions[\"errorPolicy\"] extends \"ignore\" | \"all\" ?\n    TOptions[\"returnPartialData\"] extends true ?\n      DeepPartial<TData> | undefined\n    : TData | undefined\n  : TOptions[\"returnPartialData\"] extends true ? DeepPartial<TData>\n  : TData,\n  TVariables\n>;\n\nexport function useLoadableQuery<\n  TData = unknown,\n  TVariables extends OperationVariables = OperationVariables,\n>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options: LoadableQueryHookOptions & {\n    returnPartialData: true;\n    errorPolicy: \"ignore\" | \"all\";\n  }\n): UseLoadableQueryResult<DeepPartial<TData> | undefined, TVariables>;\n\nexport function useLoadableQuery<\n  TData = unknown,\n  TVariables extends OperationVariables = OperationVariables,\n>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options: LoadableQueryHookOptions & {\n    errorPolicy: \"ignore\" | \"all\";\n  }\n): UseLoadableQueryResult<TData | undefined, TVariables>;\n\nexport function useLoadableQuery<\n  TData = unknown,\n  TVariables extends OperationVariables = OperationVariables,\n>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options: LoadableQueryHookOptions & {\n    returnPartialData: true;\n  }\n): UseLoadableQueryResult<DeepPartial<TData>, TVariables>;\n\n/**\n * A hook for imperatively loading a query, such as responding to a user\n * interaction.\n *\n * > Refer to the [Suspense - Fetching in response to user interaction](https://www.apollographql.com/docs/react/data/suspense#fetching-in-response-to-user-interaction) section for a more in-depth overview of `useLoadableQuery`.\n *\n * @example\n * ```jsx\n * import { gql, useLoadableQuery } from \"@apollo/client\";\n *\n * const GET_GREETING = gql`\n *   query GetGreeting($language: String!) {\n *     greeting(language: $language) {\n *       message\n *     }\n *   }\n * `;\n *\n * function App() {\n *   const [loadGreeting, queryRef] = useLoadableQuery(GET_GREETING);\n *\n *   return (\n *     <>\n *       <button onClick={() => loadGreeting({ language: \"english\" })}>\n *         Load greeting\n *       </button>\n *       <Suspense fallback={<div>Loading...</div>}>\n *         {queryRef && <Hello queryRef={queryRef} />}\n *       </Suspense>\n *     </>\n *   );\n * }\n *\n * function Hello({ queryRef }) {\n *   const { data } = useReadQuery(queryRef);\n *\n *   return <div>{data.greeting.message}</div>;\n * }\n * ```\n *\n * @since 3.9.0\n * @param query - A GraphQL query document parsed into an AST by `gql`.\n * @param options - Options to control how the query is executed.\n * @returns A tuple in the form of `[loadQuery, queryRef, handlers]`\n */\nexport function useLoadableQuery<\n  TData = unknown,\n  TVariables extends OperationVariables = OperationVariables,\n>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: LoadableQueryHookOptions\n): UseLoadableQueryResult<TData, TVariables>;\n\nexport function useLoadableQuery<\n  TData = unknown,\n  TVariables extends OperationVariables = OperationVariables,\n>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options: LoadableQueryHookOptions = Object.create(null)\n): UseLoadableQueryResult<TData, TVariables> {\n  const client = useApolloClient(options.client);\n  const suspenseCache = getSuspenseCache(client);\n  const watchQueryOptions = useWatchQueryOptions({ client, query, options });\n  const { queryKey = [] } = options;\n\n  const [queryRef, setQueryRef] = React.useState<QueryRef<\n    TData,\n    TVariables\n  > | null>(null);\n\n  assertWrappedQueryRef(queryRef);\n\n  const internalQueryRef = queryRef && unwrapQueryRef(queryRef);\n\n  if (queryRef && internalQueryRef?.didChangeOptions(watchQueryOptions)) {\n    const promise = internalQueryRef.applyOptions(watchQueryOptions);\n    updateWrappedQueryRef(queryRef, promise);\n  }\n\n  const calledDuringRender = useRenderGuard();\n\n  const fetchMore: FetchMoreFunction<TData, TVariables> = React.useCallback(\n    (options) => {\n      if (!internalQueryRef) {\n        throw new Error(\n          \"The query has not been loaded. Please load the query.\"\n        );\n      }\n\n      const promise = internalQueryRef.fetchMore(\n        options as FetchMoreQueryOptions<TVariables, TData>\n      );\n\n      setQueryRef(wrapQueryRef(internalQueryRef));\n\n      return promise;\n    },\n    [internalQueryRef]\n  );\n\n  const refetch: RefetchFunction<TData, TVariables> = React.useCallback(\n    (options) => {\n      if (!internalQueryRef) {\n        throw new Error(\n          \"The query has not been loaded. Please load the query.\"\n        );\n      }\n\n      const promise = internalQueryRef.refetch(options);\n\n      setQueryRef(wrapQueryRef(internalQueryRef));\n\n      return promise;\n    },\n    [internalQueryRef]\n  );\n\n  const loadQuery: LoadQueryFunction<TVariables> = React.useCallback(\n    (...args) => {\n      invariant(\n        !calledDuringRender(),\n        \"useLoadableQuery: 'loadQuery' should not be called during render. To start a query during render, use the 'useBackgroundQuery' hook.\"\n      );\n\n      const [variables] = args;\n\n      const cacheKey: CacheKey = [\n        query,\n        canonicalStringify(variables),\n        ...([] as any[]).concat(queryKey),\n      ];\n\n      const queryRef = suspenseCache.getQueryRef(cacheKey, () =>\n        client.watchQuery({\n          ...watchQueryOptions,\n          variables,\n        } as WatchQueryOptions<any, any>)\n      );\n\n      setQueryRef(wrapQueryRef(queryRef));\n    },\n    [\n      query,\n      queryKey,\n      suspenseCache,\n      watchQueryOptions,\n      calledDuringRender,\n      client,\n    ]\n  );\n\n  const subscribeToMore: SubscribeToMoreFunction<TData, TVariables> =\n    React.useCallback(\n      (options) => {\n        invariant(\n          internalQueryRef,\n          \"The query has not been loaded. Please load the query.\"\n        );\n\n        return internalQueryRef.observable.subscribeToMore(options);\n      },\n      [internalQueryRef]\n    );\n\n  const reset: ResetFunction = React.useCallback(() => {\n    setQueryRef(null);\n  }, []);\n\n  return [loadQuery, queryRef, { fetchMore, refetch, reset, subscribeToMore }];\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}